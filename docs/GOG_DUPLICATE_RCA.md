# Root Cause Analysis: GOG Gmail Connector Duplicate Linear Tickets

**Date:** 2026-02-11  
**Incident:** Same Nathan Ellis (Deloitte) email filed as Linear tickets 4 separate times (ENG-8201‚Äì8212)  
**Severity:** High ‚Äî wastes agent compute, creates noise, erodes trust in automation  

---

## Executive Summary

**Three independent failures** combined to produce quadruple ticket creation:

1. **Connector seen-ID cache not persisting** ‚Äî cache dir `/tmp/orgloop-gog/` doesn't exist at runtime, so every poll re-emits all recent emails
2. **Dedup transform config field mismatch** ‚Äî config uses `fields` but code reads `key`, causing fallback to default keys that include the auto-generated UUID `id`, making every event unique ‚Üí dedup never drops anything
3. **No checkpoint persistence in daemon** ‚Äî the GOG connector's checkpoint (historyId) is not being persisted between daemon restarts, so every restart triggers a full bootstrap poll

The SOP's idempotency check (Step 2: "Check for Existing Linear Tickets") was correctly authored but the agent received 4 separate deliveries to session `orgloop:gmail:triage` ‚Äî each as a fresh wake with no context of prior filings.

---

## Detailed Analysis

### Layer 1: GOG Connector ‚Äî Seen-ID Cache Failure

**File:** `~/personal/orgloop-gog-connector/connectors/gog/src/source.ts`

The connector maintains a `seenIds` Set backed by a file cache at `{cacheDir}/{sourceId}-seen-ids.json`. The default `cacheDir` is `os.tmpdir() + '/orgloop-gog'`.

**Evidence:** `/tmp/orgloop-gog/` does not exist on disk. The `init()` method calls `mkdirSync(this.cacheDir, { recursive: true })` which should create it, but either:
- The installed `@orgloop/connector-gog` package differs from source (build not deployed)
- The connector init is throwing silently and the daemon swallows the error
- macOS temp cleanup removed it between daemon restarts

**Impact:** Without the file cache, every daemon restart loses all seen IDs. The in-memory Set only deduplicates within a single daemon lifecycle.

**Evidence from logs:** The daemon emits **20 GOG events per poll cycle** (the `max_per_poll` setting), and this has been happening every 5 minutes across 9+ poll cycles = **180+ duplicate event emissions** for the same email set.

### Layer 2: Dedup Transform ‚Äî Config Field Name Mismatch (CRITICAL BUG)

**Config file:** `~/code/mono-orgloop/orgloop/charlie-mac-studio/transforms/engineering.yaml`
```yaml
- name: dedup
  type: package
  package: "@orgloop/transform-dedup"
  config:
    window: "10m"
    fields:          # ‚Üê Config uses "fields"
      - "type"
      - "provenance.source"
      - "provenance.resource_id"
```

**Transform code:** `~/personal/orgloop/transforms/dedup/src/dedup.ts`
```typescript
interface DedupConfig {
    key: string[];    // ‚Üê Code reads "key", NOT "fields"
    window: string;
}

async init(config: Record<string, unknown>): Promise<void> {
    const c = config as unknown as Partial<DedupConfig>;
    this.config = {
        key: c.key ?? ['source', 'type', 'id'],  // ‚Üê Falls back to default
        // ...
    };
}
```

**The bug:** Config passes `fields: [...]` but the DedupTransform reads `config.key`. Since `config.key` is undefined, it falls back to `['source', 'type', 'id']`.

The `id` field is generated by `buildEvent()` ‚Üí `generateEventId()` which produces a unique UUID (`evt_xxxx`) for every event. **This means the dedup hash is always unique and dedup NEVER drops anything.**

**Evidence from logs:** Every single GOG event shows `transform.pass`, zero `transform.drop`:
```
{"phase":"transform.pass","route":"gmail-triage","transform":"dedup","duration_ms":0}
```

**Additional issue:** Even if the field name were correct, the config uses `provenance.resource_id` but the GOG normalizer never sets `resource_id` in provenance. The correct dedup key should use `payload.message_id` (the Gmail message ID).

### Layer 3: No Checkpoint Persistence

**Evidence:** `~/.orgloop/state.json` contains source metadata but NO checkpoint data for the GOG connector. The GOG connector's `poll()` method receives `checkpoint: null` on every invocation.

Without a checkpoint, the connector enters bootstrap mode every time:
```typescript
if (!cp.historyId) {
    // Bootstrap: search newer_than:5m
    const bootstrapResult = await this.execGog(['gmail', 'messages', 'search', 'newer_than:5m', ...]);
```

Since the Nathan Ellis email is within the 5-minute window (or the email thread keeps appearing in results), it gets re-discovered on every poll.

**Root question:** Does the OrgLoop daemon persist connector checkpoints? The state.json structure suggests it tracks health but not checkpoints. This is likely a daemon bug or missing feature.

### Layer 4: Session Isolation

The route config delivers to session `orgloop:gmail:triage`:
```yaml
config:
  session_key: "orgloop:gmail:triage"
  wake_mode: now
  deliver: true
```

Each delivery wakes the agent with the event payload. If these go to the **same** persistent session, the agent could theoretically see prior context. But with `wake_mode: now`, each delivery likely creates a fresh agent invocation with no memory of having already filed tickets from the same email.

The SOP correctly instructs the agent to search Linear first (Step 2), but the agent processes each delivery independently and may not execute the search correctly under rapid-fire deliveries.

### Layer 5: Duplicate Log Lines

Every log entry appears exactly **twice** ‚Äî suggesting either dual loggers configured (file + stdout) both writing to the same file, or a logger registration bug. This is cosmetic but worth fixing.

---

## Timeline Reconstruction

| Time (UTC) | Event |
|---|---|
| ~00:14:59 | First GOG poll ‚Äî 20 emails emitted (40 log lines due to dual logging) |
| ~00:15:45 | Second poll ‚Äî same 20 emails re-emitted (seen cache lost, dedup passes all) |
| ~00:20:45 | Third poll ‚Äî same pattern continues |
| Every 5min | Continues: 00:25, 00:30, 00:35, 00:40, 00:50, 00:55 |
| Various | Agent receives Nathan Ellis email 4+ times, files tickets each time |

**Total GOG events emitted this session:** 40 per cycle √ó 9 cycles = **360 events** (180 unique, each logged twice). The daemon has been running for ~470 seconds (uptime_ms in state.json = 470046), confirming this is a single daemon session with repeated polling.

---

## Root Causes (Ranked by Impact)

### üî¥ RC-1: Dedup Transform Config Mismatch (BUG)
- **Layer:** Transform
- **Type:** Code bug
- **File:** `~/personal/orgloop/transforms/dedup/src/dedup.ts` line ~50
- **Fix:** Change `DedupConfig.key` to `DedupConfig.fields` OR change config YAML from `fields:` to `key:`
- **Recommended:** Update the transform to accept BOTH `key` and `fields` (with `fields` as alias) for backwards compatibility

### üî¥ RC-2: Dedup Key Uses Wrong Field Paths
- **Layer:** Config
- **Type:** Config bug
- **File:** `~/code/mono-orgloop/orgloop/charlie-mac-studio/transforms/engineering.yaml`
- **Fix:** Change dedup fields to:
  ```yaml
  key:  # (after fixing RC-1)
    - "type"
    - "source"
    - "payload.message_id"
  ```
- The `provenance.resource_id` field is never set by the GOG normalizer. The stable identifier is `payload.message_id` (Gmail's message ID).

### üü° RC-3: Checkpoint Not Persisted
- **Layer:** Daemon / Connector
- **Type:** Missing feature or bug
- **Fix:** The OrgLoop daemon needs to persist connector checkpoints to `state.json` (or a dedicated checkpoint store) and pass them back on subsequent polls. Without this, every poll starts from scratch.
- **File:** Check the daemon's poll loop in `~/personal/orgloop/packages/cli/src/commands/apply.ts`

### üü° RC-4: Seen-ID Cache Dir Missing
- **Layer:** Connector
- **Type:** Likely deployment/build mismatch
- **Fix:** Verify the installed `@orgloop/connector-gog` matches source. Add error logging if `mkdirSync` fails. Consider using `~/.orgloop/cache/` instead of `/tmp/` for persistence across reboots.
- **File:** `~/personal/orgloop-gog-connector/connectors/gog/src/source.ts` line ~120

### üü¢ RC-5: GOG Normalizer Missing `resource_id`
- **Layer:** Connector
- **Type:** Gap
- **Fix:** Set `provenance.resource_id: message.id` in `normalizeEmailReceived()` so standard dedup patterns work
- **File:** `~/personal/orgloop-gog-connector/connectors/gog/src/normalizer.ts`

---

## Recommended Fixes (Priority Order)

### Immediate (Fix Today)

1. **Fix dedup config field name** ‚Äî Either:
   - Change `engineering.yaml` from `fields:` to `key:` (quick fix), OR
   - Update `dedup.ts` to read `config.fields ?? config.key ?? defaults` (proper fix)

2. **Fix dedup key paths** ‚Äî Change to `["type", "source", "payload.message_id"]`

3. **Rebuild & redeploy GOG connector** ‚Äî Ensure the installed package matches source so seen-ID cache works

### Short-Term (This Week)

4. **Persist checkpoints in daemon** ‚Äî Store checkpoint per source in state.json
5. **Move seen-ID cache out of /tmp** ‚Äî Use `~/.orgloop/cache/gog/` for durability
6. **Add `provenance.resource_id`** to GOG normalizer

### Medium-Term

7. **Add dedup integration test** ‚Äî Verify dedup actually drops duplicate events end-to-end
8. **Add config validation** ‚Äî The dedup transform should warn/error on unknown config keys
9. **Fix dual logging** ‚Äî Each event being logged twice is noisy

---

## Verification Plan

After fixes are applied:
1. Restart daemon
2. Watch logs: `tail -f ~/.orgloop/logs/orgloop.log | grep -E "dedup|gog"`
3. Confirm: first poll shows `transform.pass`, subsequent polls show `transform.drop` for same emails
4. Confirm: `/tmp/orgloop-gog/` (or new cache path) contains seen-IDs JSON
5. Confirm: checkpoint appears in state.json after first poll

---

## Classification

| Aspect | Finding |
|---|---|
| Primary failure | Dedup transform config bug (code reads `key`, config says `fields`) |
| Contributing failures | No checkpoint persistence, seen-ID cache missing, wrong dedup key paths |
| SOP gap? | No ‚Äî SOP correctly includes idempotency check (Step 2). The issue is upstream. |
| Session gap? | Minor ‚Äî rapid-fire deliveries to same session may overwhelm the idempotency check |
| Connector bug? | Yes ‚Äî missing `resource_id` in provenance, fragile cache dir |
| Config bug? | Yes ‚Äî wrong field name, wrong key paths |
| Daemon bug? | Yes ‚Äî no checkpoint persistence |
